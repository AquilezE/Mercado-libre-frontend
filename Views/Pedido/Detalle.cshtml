@model Pedido
@{
    ViewData["Title"] = "Pedidos";
    ViewData["SubTitle"] = "Detalle del Pedido";
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb small">
        <li class="breadcrumb-item">
            <a class="text-decoration-none" title="Regresar al listado" asp-action="Index">Listado</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">@ViewData["SubTitle"]</li>
    </ol>
</nav>

<h2 class="text-center mb-3">@ViewData["Title"] <small class="text-muted fs-5">@ViewData["SubTitle"]</small></h2>

<!-- Información Principal del Pedido -->
<div class="card mt-3">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-receipt"></i> Información del Pedido
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td><strong>ID del Pedido:</strong></td>
                        <td>@Html.DisplayFor(model => model.Id)</td>
                    </tr>
                    <tr>
                        <td><strong>Dirección de Envío:</strong></td>
                        <td>
                            @if (Model.Direccion != null)
                            {
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-geo-alt-fill text-primary me-2 mt-1"></i>
                                    <div>
                                        <div><strong>@Model.Direccion.Calle</strong></div>
                                        <div class="text-muted small">
                                            @Model.Direccion.Ciudad, @Model.Direccion.CodigoPostal
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="text-muted">
                                    <i class="bi bi-geo-alt text-muted me-1"></i>
                                    Dirección ID: @Model.DireccionId
                                    <small class="d-block">Información no disponible</small>
                                </div>
                            }
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td><strong>Estado:</strong></td>
                        <td>
                            <span class="badge rounded-pill fs-6
                                @(Model.Estado == "pendiente" ? "text-bg-warning" :
                                                                    Model.Estado == "confirmado" ? "text-bg-success" :
                                                                    Model.Estado == "cancelado" ? "text-bg-danger" : "text-bg-secondary")">
                                @Html.DisplayFor(model => model.Estado)
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Fecha de Creación:</strong></td>
                        <td>@Html.DisplayFor(model => model.CreadoEn)</td>
                    </tr>
                    <tr>
                        <td><strong>Total del Pedido:</strong></td>
                        <td><strong class="text-primary fs-5">@Html.DisplayFor(model => model.Total)</strong></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Items del Pedido -->
<div class="card mt-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-list-ul"></i> Items del Pedido
        </h5>
        <span class="badge bg-secondary rounded-pill">@Model.Items.Count item(s)</span>
    </div>
    <div class="card-body">
        @if (Model.Items != null && Model.Items.Any())
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th width="5%">Item</th>
                            <th width="8%">Imagen</th>
                            <th>Producto</th>
                            <th width="10%" class="text-center">Cantidad</th>
                            <th width="15%" class="text-end">Precio Unit.</th>
                            <th width="15%" class="text-end">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Items)
                        {
                            <tr>
                                <td class="align-middle">
                                    <small class="text-muted">#@item.Id</small>
                                </td>
                                <td class="align-middle text-center">
                                    @if (item.Producto != null)
                                    {
                                        <img src="@(item.Producto.ArchivoId == null ? "https://via.placeholder.com/40x40" : $"{ViewBag.Url}/api/archivos/{item.Producto.ArchivoId}")"
                                             alt="@item.Producto.Titulo"
                                             class="img-fluid img-thumbnail"
                                             style="max-height: 40px; max-width: 40px;" />
                                    }
                                    else
                                    {
                                        <div class="bg-light border rounded d-flex align-items-center justify-content-center"
                                             style="width: 40px; height: 40px;">
                                            <i class="bi bi-image text-muted"></i>
                                        </div>
                                    }
                                </td>
                                <td class="align-middle">
                                    @if (item.Producto != null)
                                    {
                                        <div>
                                            <strong>@item.Producto.Titulo</strong>
                                        </div>
                                        <div class="text-muted small">
                                            @if (!string.IsNullOrEmpty(item.Producto.Descripcion) && item.Producto.Descripcion.Length > 80)
                                            {
                                                @(item.Producto.Descripcion.Substring(0, 80))
                                            }
                                            else
                                            {
                                                @item.Producto.Descripcion
                                            }
                                        </div>
                                        @if (item.Producto.Categorias != null && item.Producto.Categorias.Any())
                                        {
                                            <div class="mt-1">
                                                @foreach (var cat in item.Producto.Categorias.Take(2))
                                                {
                                                    <span class="badge rounded-pill text-bg-secondary me-1 small">@cat.Nombre</span>
                                                }
                                                @if (item.Producto.Categorias.Count > 2)
                                                {
                                                    <span class="text-muted small">+@(item.Producto.Categorias.Count - 2) más</span>
                                                }
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-muted">
                                            <strong>Producto ID: @item.ProductoId</strong>
                                            <br><small>Producto no disponible</small>
                                        </div>
                                    }
                                </td>
                                <td class="align-middle text-center">
                                    <span class="badge bg-info rounded-pill">@item.Cantidad</span>
                                </td>
                                <td class="align-middle text-end">
                                    @Html.DisplayFor(modelItem => item.PrecioUnitario)
                                </td>
                                <td class="align-middle text-end">
                                    <strong>@((item.Cantidad * item.PrecioUnitario).ToString("C"))</strong>
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="5" class="text-end"><strong>Total del Pedido:</strong></td>
                            <td class="text-end"><strong class="text-primary fs-5">@Html.DisplayFor(model => model.Total)</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-4">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <p class="text-muted mt-3">Este pedido no tiene items registrados.</p>
            </div>
        }
    </div>
</div>

<!-- Información Adicional -->
@if (Model.ActualizadoEn.HasValue && Model.ActualizadoEn != Model.CreadoEn)
{
    <div class="card mt-3">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="bi bi-clock-history"></i> Historial
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">
                        <strong>Creado:</strong> @Html.DisplayFor(model => model.CreadoEn)
                    </small>
                </div>
                <div class="col-md-6">
                    <small class="text-muted">
                        <strong>Última actualización:</strong> @Html.DisplayFor(model => model.ActualizadoEn)
                    </small>
                </div>
            </div>
        </div>
    </div>
}

<!-- Botones de Acción -->
<div class="text-center mt-4">
    <a class="btn btn-outline-secondary" asp-action="Index">
        <i class="bi bi-arrow-left"></i> Volver al Listado
    </a>

    @if (ViewBag.SoloAdmin == true)
    {
        @if (Model.Estado == "pendiente")
        {
            <button class="btn btn-success ms-2" onclick="confirmarPedido(@Model.Id)">
                <i class="bi bi-check-circle"></i> Confirmar Pedido
            </button>
            <button class="btn btn-danger ms-2" onclick="cancelarPedido(@Model.Id)">
                <i class="bi bi-x-circle"></i> Cancelar Pedido
            </button>
        }
    }

</div>

@if (ViewBag.SoloAdmin == true)
{
    @section Scripts {
        <script>
            function confirmarPedido(pedidoId) {
                if (confirm('¿Está seguro que desea confirmar este pedido?')) {
                    // Implement confirm order functionality
                    console.log('Confirming order:', pedidoId);
                }
            }

            function cancelarPedido(pedidoId) {
                if (confirm('¿Está seguro que desea cancelar este pedido? Esta acción no se puede deshacer.')) {
                    // Implement cancel order functionality
                    console.log('Canceling order:', pedidoId);
                }
            }
        </script>
    }
}
