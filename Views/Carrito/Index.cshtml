@model Carrito
@{
    ViewData["Title"] = "Carrito de compras";
    ViewData["SubTitle"] = "Listado";
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb small">
        <li class="breadcrumb-item active" aria-current="page">@ViewData["SubTitle"]</li>
    </ol>
</nav>

<h2 class="text-center mb-3">@ViewData["Title"] <small class="text-muted fs-5">@ViewData["SubTitle"]</small></h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="row small mb-3">
    <div class="col">
        @if (Model.Items.Count > 0)
        {
            <form asp-action="LimpiarCarrito" method="post" style="display: inline;">
                @Html.AntiForgeryToken()
                <button type="submit" class="text-decoration-none btn btn-link p-0 text-danger small"
                        onclick="return confirm('¿Está seguro que desea limpiar todo el carrito?')"
                        title="Limpiar carrito">
                    Limpiar carrito
                </button>
            </form>
        }
    </div>
    <div class="col text-end">
        Mostrando @Model.Items.Count elementos
    </div>
</div>

@if (Model.Items.Count > 0)
{
    <div class="table-responsive">
        <table class="table table-striped table-bordered small">
            <thead class="text-center">
                <tr>
                    <th width="1%">Imagen</th>
                    <th>Producto</th>
                    <th width="15%">@Html.DisplayNameFor(model => model.Items.First().PrecioUnitario)</th>
                    <th width="10%">@Html.DisplayNameFor(model => model.Items.First().Cantidad)</th>
                    <th width="8%">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td class="text-center">
                            @if (item.Producto != null)
                            {
                                <img src="@(item.Producto.ArchivoId == null ? "https://via.placeholder.com/27x40" : $"{ViewBag.Url}/api/archivos/{item.Producto.ArchivoId}")"
                                     alt="@item.Producto.Titulo"
                                     class="img-fluid img-thumbnail"
                                     style="max-height: 40px;" />
                            }
                            else
                            {
                                <img src="https://via.placeholder.com/27x40" alt="Producto" class="img-fluid img-thumbnail" style="max-height: 40px;" />
                            }
                        </td>
                        <td>
                            @if (item.Producto != null)
                            {
                                @Html.DisplayFor(modelItem => item.Producto.Titulo)
                    
                                <br />
                                <span class="text-secondary-emphasis small d-none d-md-block">@Html.DisplayFor(modelItem => item.Producto.Descripcion)</span>

                                <br />
                                @if (item.Producto.Categorias != null)
                                {
                                    @foreach (var cat in item.Producto.Categorias)
                                    {
                                        <span class="badge rounded-pill text-bg-secondary">@cat.Nombre</span>
                                    }
                                }
                            }
                            else
                            {
                                <span class="text-muted">Producto no disponible</span>
                            }
                        </td>
                        <td class="text-center">
                            @Html.DisplayFor(modelItem => item.PrecioUnitario)
                        </td>
                        <td class="text-center">
                            <form asp-action="ActualizarCantidad" method="post" style="display: inline;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="itemId" value="@item.ItemId" />
                                <div class="input-group input-group-sm">
                                    <input type="number" name="cantidad" value="@item.Cantidad" min="1" max="10"
                                           class="form-control text-center" style="max-width: 70px;">
                                    <button type="submit" class="btn btn-outline-primary btn-sm" title="Actualizar">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </div>
                            </form>
                        </td>
                        <td class="text-center">
                            <a class="text-decoration-none small text-uppercase text-danger"
                               asp-action="RemoverConfirmar" asp-route-itemId="@item.ItemId">Remover</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="card mt-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h5>Total de productos: @Model.TotalItems</h5>
                </div>
                <div class="col-md-4 text-end">
                    <h4 class="text-primary fw-bold">Total: @Html.DisplayFor(model => model.Total)</h4>
                    <a class="btn btn-success btn-lg" asp-action="Checkout">
                        <i class="bi bi-credit-card"></i> Proceder al Pago
                    </a>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="mt-5">
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-cart-x"></i> Su carrito está vacío.
            <a asp-controller="Comprar" asp-action="Index" class="alert-link">¡Comience a comprar ahora!</a>
        </div>
    </div>
}