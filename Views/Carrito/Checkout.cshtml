@model CheckoutRequest
@{
    ViewData["Title"] = "Checkout";
    ViewData["SubTitle"] = "Finalizar Compra";
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb small">
        <li class="breadcrumb-item">
            <a class="text-decoration-none" asp-action="Index">Carrito</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">@ViewData["SubTitle"]</li>
    </ol>
</nav>

<h2 class="text-center mb-3">@ViewData["Title"] <small class="text-muted fs-5">@ViewData["SubTitle"]</small></h2>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="row">
    <div class="col-md-6">
        <h4 class="mb-3">Resumen del Pedido</h4>
        @if (ViewBag.Carrito is Carrito carritoData && carritoData.Items != null)
        {
            <div class="table-responsive">
                <table class="table table-sm">
                    <tbody>
                        @foreach (var item in carritoData.Items)
                        {
                            <tr>
                                <td>@(item.Producto?.Titulo ?? "Producto")</td>
                                <td class="text-center">@item.Cantidad</td>
                                <td class="text-end">@Html.DisplayFor(modelItem => item.PrecioUnitario)</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr class="table-primary">
                            <td colspan="2"><strong>Total</strong></td>
                            <td class="text-end"><strong>@Html.DisplayFor(modelItem => carritoData.Total)</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        }
    </div>

    <div class="col-md-6">
        <h4 class="mb-3">Dirección de Entrega</h4>

        <form asp-action="Checkout" method="post">
            @Html.AntiForgeryToken()

            @if (ViewBag.Direcciones is List<Direccion> direcciones && direcciones.Count > 0)
            {
                <div class="mb-3">
                    @foreach (var direccion in direcciones)
                    {
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="DireccionId" value="@direccion.Id" id="dir@(direccion.Id)" required>
                            <label class="form-check-label" for="dir@(direccion.Id)">
                                <strong>@direccion.Calle</strong><br>
                                <small class="text-muted">@direccion.Ciudad, @direccion.CodigoPostal</small>
                            </label>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-warning">
                    No tiene direcciones registradas.
                    <a href="#" class="alert-link">Agregue una dirección</a> antes de continuar.
                </div>
            }
                        <div class="mb-3 text-center">
                <a asp-controller="Direccion" asp-action="Crear" asp-route-returnUrl="@Url.Action("Checkout", "Carrito")" 
                   class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-plus-circle"></i> Agregar nueva dirección
                </a>
            </div>

            <div class="d-grid gap-2">
                @if (ViewBag.Direcciones is List<Direccion> dirs && dirs.Count > 0)
                {
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle"></i> Confirmar Pedido
                    </button>
                }
                <a class="btn btn-outline-secondary" asp-action="Index">
                    <i class="bi bi-arrow-left"></i> Volver al Carrito
                </a>
            </div>
        </form>
    </div>
</div>
